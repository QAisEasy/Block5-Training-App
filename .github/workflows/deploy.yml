name: Deploy to QA

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: QA
    
    steps:
    - name: Deploy to server via SSH
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ secrets.SERVER_PORT }}
        script: |
          # ÐŸÐµÑ€ÐµÑ…Ð¾Ð´Ð¸Ð¼ Ð² Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
          cd /opt/ecommerce || {
            echo "Project directory not found, creating..."
            sudo mkdir -p /opt/ecommerce
            sudo chown -R $USER:$USER /opt/ecommerce
            cd /opt/ecommerce
          }
          
          # Ð•ÑÐ»Ð¸ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹ ÐµÑ‰Ðµ Ð½Ðµ ÑÐºÐ»Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½, ÐºÐ»Ð¾Ð½Ð¸Ñ€ÑƒÐµÐ¼ ÐµÐ³Ð¾
          if [ ! -d ".git" ]; then
            echo "Cloning repository..."
            git clone https://github.com/${{ github.repository }}.git .
          else
            echo "Pulling latest changes..."
            git fetch origin
            git reset --hard origin/${{ github.ref_name }}
          fi
          
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ .env Ñ„Ð°Ð¹Ð»Ñ‹ ÐµÑÐ»Ð¸ Ð¸Ñ… Ð½ÐµÑ‚
          if [ ! -f ".env.db" ]; then
            echo "Creating .env.db file..."
            cat > .env.db << 'EOL'
          MYSQL_ROOT_PASSWORD=rootpassword
          MYSQL_DATABASE=mydatabase
          MYSQL_USER=user
          MYSQL_PASSWORD=password
          EOL
          fi
          
          if [ ! -f ".env.app" ]; then
            echo "Creating .env.app file..."
            cat > .env.app << 'EOL'
          DATABASE_URL=mysql+pymysql://user:password@db/mydatabase
          EOL
          fi
          
          if [ ! -f ".env.sales" ]; then
            echo "Creating .env.sales file..."
            cat > .env.sales << 'EOL'
          DATABASE_URL=mysql+pymysql://user:password@db/mydatabase
          EOL
          fi
          
          # Ð”Ð°ÐµÐ¼ Ð¿Ñ€Ð°Ð²Ð° Ð½Ð° Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ ÑÐºÑ€Ð¸Ð¿Ñ‚Ð°Ð¼
          chmod +x docker-manager.sh
          
          # ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ðµ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹
          echo "Stopping old containers..."
          ./docker-manager.sh stop || true
          
          # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹
          echo "Starting containers..."
          ./docker-manager.sh start
          
          # Ð–Ð´ÐµÐ¼ Ð¿Ð¾ÐºÐ° Ð±Ð°Ð·Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑÑ
          echo "Waiting for database to be ready..."
          sleep 15
          
          # Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ demo Ð´Ð°Ð½Ð½Ñ‹Ðµ (Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¿Ñ€Ð¸ Ð¿ÐµÑ€Ð²Ð¾Ð¼ Ð´ÐµÐ¿Ð»Ð¾Ðµ)
          if [ ! -f ".db_initialized" ]; then
            echo "Loading demo data..."
            # ÐÐ°Ñ…Ð¾Ð´Ð¸Ð¼ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…
            DB_CONTAINER=$(docker ps --format "table {{.Names}}" | grep -E "db|mysql" | head -1)
            if [ ! -z "$DB_CONTAINER" ]; then
              if [ -f "./common/db/dump/dump.sql" ]; then
                docker exec -i $DB_CONTAINER sh -c 'exec mysql -u user -ppassword mydatabase' < ./common/db/dump/dump.sql && \
                touch .db_initialized && \
                echo "Demo data loaded successfully!"
              else
                echo "Warning: dump.sql not found"
              fi
            else
              echo "Warning: Database container not found"
            fi
          fi
          
          echo "Deployment completed!"
          
          # ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð²
          docker ps

  health-check:
    needs: deploy
    runs-on: ubuntu-latest
    environment: QA
    
    steps:
    - name: Wait for services to start
      run: sleep 30
      
    - name: Check Product Service Health
      run: |
        response=$(curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.SERVER_HOST }}:8000/docs || echo "000")
        echo "Product Service HTTP Response: $response"
        if [ "$response" = "200" ]; then
          echo "âœ… Product service is healthy"
        else
          echo "âŒ Product service is not responding correctly"
          echo "Trying to get more info..."
          curl -v http://${{ secrets.SERVER_HOST }}:8000/docs || true
          exit 1
        fi
    
    - name: Check Sales Service Health
      run: |
        response=$(curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.SERVER_HOST }}:8001/docs || echo "000")
        echo "Sales Service HTTP Response: $response"
        if [ "$response" = "200" ]; then
          echo "âœ… Sales service is healthy"
        else
          echo "âŒ Sales service is not responding correctly"
          echo "Trying to get more info..."
          curl -v http://${{ secrets.SERVER_HOST }}:8001/docs || true
          exit 1
        fi
    
    - name: Summary
      run: |
        echo "ðŸŽ‰ Deployment successful!"
        echo "ðŸ“¦ Product Service: http://${{ secrets.SERVER_HOST }}:8000/docs"
        echo "ðŸ’° Sales Service: http://${{ secrets.SERVER_HOST }}:8001/docs"